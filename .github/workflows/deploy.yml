name: Deploy to AWS EC2

on:
  push:
    branches: [ aws_deployment ]
    paths:
      # Only trigger on code changes, not documentation
      - 'backend/**'
      - 'frontend/**'
      - 'src/**'
      - 'requirements.txt'
      - 'run_app.py'
      - 'inference_phams.yaml'
      - 'parms.yaml'
      - 'deploy.sh'
      - 'auto_update.sh'
      - '.streamlit/**'
      - '.github/workflows/**'
      # Exclude documentation and configs
      - '!**.md'
      - '!DEPLOYMENT_GUIDE.md'
      - '!README.md'
      - '!.gitignore'
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to EC2
      env:
        PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        HOST: ${{ secrets.EC2_HOST }}
        USER: ubuntu
      run: |
        echo "Starting deployment to AWS EC2..."
        
        # Setup SSH
        echo "$PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem
        
        # Deploy
        ssh -o StrictHostKeyChecking=no -i private_key.pem ${USER}@${HOST} << 'ENDSSH'
set -e
cd /home/ubuntu/egg_identification_quality_dashboard

echo "Pulling latest changes..."
git pull origin aws_deployment

echo "Activating virtual environment..."
source venv/bin/activate

echo "Updating dependencies..."
pip install -r requirements.txt --upgrade

echo "Restarting services..."
sudo systemctl restart egg-backend
sudo systemctl restart egg-frontend

echo "Deployment complete!"
ENDSSH
        
        # Cleanup
        rm -f private_key.pem
        echo "Deployment finished successfully"
        
    - name: Verify Deployment
      env:
        HOST: ${{ secrets.EC2_HOST }}
      run: |
        echo "Verifying deployment..."
        sleep 15
        
        # Check if services are responding (non-failing)
        echo "Checking frontend..."
        curl -s -o /dev/null -w "Frontend status: %{http_code}\n" http://${HOST}:8501 || echo "Frontend starting..."
        
        echo "Checking backend..."
        curl -s -o /dev/null -w "Backend status: %{http_code}\n" http://${HOST}:8000/docs || echo "Backend starting..."
        
        echo "Deployment verification complete! Services may take 30-60 seconds to fully start."
